<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Utkarsh AI Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-main: #ffffff;
            --bg-sidebar: #f9f9f9;
            --text-main: #0d0d0d;
            --text-muted: #666666;
            --border-color: #e5e5e5;
            --user-bubble: #f4f4f4;
            --ai-bubble: transparent;
            --accent: #10a37f;
            --utkarsh-red: #ff4b4b;
        }

        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg-main); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }

        #welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 2000; transition: 0.4s; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 10px 40px rgba(0,0,0,0.08); width: 100%; max-width: 350px; }
        .modal-content h2 { margin-top: 0; font-weight: 600; font-size: 22px; }
        .modal-content p { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; }
        .modal-content input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border-color); background: #f9f9f9; font-size: 16px; text-align: center; margin-bottom: 20px; outline: none; box-sizing: border-box; }
        .modal-content input:focus { border-color: var(--text-main); background: white; }
        .modal-content button { width: 100%; padding: 14px; background: var(--text-main); color: white; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; }

        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; transition: 0.3s; z-index: 100; }
        .new-chat-btn { background: #fff; color: var(--text-main); border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 14px; font-weight: 600; }
        .history-list { flex: 1; overflow-y: auto; margin-top: 20px; display: flex; flex-direction: column; gap: 5px; }
        .history-item { padding: 12px; border-radius: 8px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .history-item.active { background: #e5e5e5; font-weight: 500; }
        .brand-watermark { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: center; font-size: 12px; color: var(--text-muted); font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .brand-watermark i { color: var(--utkarsh-red); }

        .main-area { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .mobile-header { display: none; padding: 15px 20px; border-bottom: 1px solid var(--border-color); align-items: center; gap: 15px; background: white; z-index: 50; }
        .menu-btn { background: transparent; border: none; font-size: 20px; cursor: pointer; color: var(--text-main); padding: 0; }

        .chat-container { flex: 1; overflow-y: auto; padding: 20px 10%; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        .chat-container::-webkit-scrollbar { display: none; } /* Hide scrollbar on mobile for clean look */

        .message-row { display: flex; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }
        .message-content { max-width: 85%; line-height: 1.5; font-size: 15px; display: flex; gap: 12px; }
        
        .avatar { width: 28px; height: 28px; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 13px; flex-shrink: 0; margin-top: 4px; }
        .ai-avatar { background: var(--accent); color: white; border-radius: 50%; }

        .bubble { padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }
        .user .bubble { background: var(--user-bubble); color: var(--text-main); border-bottom-right-radius: 4px; }
        .ai .bubble { background: var(--ai-bubble); color: var(--text-main); padding-left: 0; }
        .bubble img { max-width: 100%; border-radius: 12px; margin-top: 8px; border: 1px solid var(--border-color); }
        .bubble pre { background: #f4f4f4; padding: 12px; border-radius: 10px; overflow-x: auto; font-size: 13px; }
        
        .typing-cursor { display: inline-block; width: 5px; height: 15px; background-color: var(--text-main); margin-left: 3px; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Mobile Perfect Input Area */
        .input-wrapper { padding: 10px 15px 20px 15px; background: white; border-top: 1px solid var(--border-color); }
        
        /* New Attached File Badge */
        .file-badge { background: #f0f0f0; color: #333; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 8px; display: none; border: 1px solid #e5e5e5; }
        
        .input-box { background: #f4f4f4; border-radius: 24px; padding: 6px 6px 6px 15px; display: flex; align-items: flex-end; gap: 10px; transition: 0.3s; }
        .input-box:focus-within { background: white; box-shadow: 0 0 0 1px #d1d5db; }
        
        .upload-btn { color: var(--text-muted); cursor: pointer; font-size: 20px; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 2px;}
        input[type="file"] { display: none; }
        
        textarea { flex: 1; background: transparent; border: none; color: var(--text-main); font-size: 16px !important; outline: none; resize: none; min-height: 24px; max-height: 120px; font-family: inherit; padding: 10px 0; }
        textarea::placeholder { color: #9ca3af; }
        
        .send-btn { background: var(--text-main); color: white; border: none; font-size: 14px; cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: 0.2s; flex-shrink: 0; }
        .send-btn:disabled { background: #e5e5e5; color: #a3a3a3; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { position: fixed; left: -300px; height: 100%; box-shadow: 5px 0 20px rgba(0,0,0,0.1); }
            .sidebar.open { left: 0; }
            .chat-container { padding: 20px 15px; }
            .message-content { max-width: 92%; }
            .input-wrapper { padding: 10px 12px 15px 12px; }
        }
    </style>
</head>
<body>

<div id="welcome-modal">
    <div class="modal-content">
        <h2>âœ¨ AI Companion</h2>
        <p>Main aapka naya AI dost hoon. Humari dosti shuru karne ke liye apna naam bataiye!</p>
        <input type="text" id="user-name-input" placeholder="Aapka naam..." onkeypress="if(event.key === 'Enter') saveName()">
        <button onclick="saveName()">Dosti Shuru Karein ðŸš€</button>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <button class="new-chat-btn" onclick="createNewChat(); closeSidebarMobile();">
        <span><i class="fa-brands fa-rocketchat"></i> New chat</span>
        <i class="fa-regular fa-pen-to-square"></i>
    </button>
    <div class="history-list" id="history-list"></div>
    <div class="brand-watermark">made by utkarsh <i class="fa-solid fa-bolt"></i></div>
</div>

<div class="main-area">
    <div class="mobile-header">
        <button class="menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div style="font-weight: 600; font-size: 16px;">AI Chat</div>
    </div>

    <div class="chat-container" id="chat-box"></div>

    <div class="input-wrapper">
        <div class="file-badge" id="file-badge"><i class="fa-solid fa-image"></i> <span id="file-name-text">image.jpg</span></div>
        <div class="input-box">
            <label class="upload-btn" for="file-input"><i class="fa-solid fa-plus"></i></label>
            <input type="file" id="file-input" accept="image/*" onchange="showFileName()">
            <textarea id="user-input" rows="1" placeholder="Message AI..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
            <button class="send-btn" id="send-btn" onclick="sendMessage()"><i class="fa-solid fa-arrow-up"></i></button>
        </div>
    </div>
</div>

<script>
    let userName = localStorage.getItem('utkarsh_user_name');
    let chats = JSON.parse(localStorage.getItem('utkarsh_chats')) || [];
    let currentChatId = null;

    window.onload = function() {
        if (!userName) { document.getElementById('welcome-modal').style.display = 'flex'; } 
        else { document.getElementById('welcome-modal').style.display = 'none'; initApp(); }
    };

    function saveName() {
        const input = document.getElementById('user-name-input').value.trim();
        if (input) {
            userName = input;
            localStorage.setItem('utkarsh_user_name', userName);
            document.getElementById('welcome-modal').style.opacity = '0';
            setTimeout(() => { document.getElementById('welcome-modal').style.display = 'none'; initApp(); }, 300);
        }
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function closeSidebarMobile() { if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open'); }
    
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function showFileName() {
        const file = document.getElementById('file-input').files[0];
        const badge = document.getElementById('file-badge');
        if(file) {
            document.getElementById('file-name-text').innerText = file.name;
            badge.style.display = 'inline-flex';
        } else { badge.style.display = 'none'; }
    }

    function handleEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey && window.innerWidth > 768) { 
            e.preventDefault(); sendMessage(); 
        }
    }

    function initApp() {
        if (chats.length === 0) createNewChat();
        else loadChat(chats[0].id);
    }

    function createNewChat() {
        currentChatId = Date.now().toString();
        chats.unshift({ id: currentChatId, title: "New Chat", messages: [] });
        saveData();
        renderSidebar();
        document.getElementById('chat-box').innerHTML = `
            <div style="text-align:center; margin-top:80px; color:#ccc; font-size:22px; font-weight:600;">
                Hello ${userName}! ðŸ‘‹<br><span style="font-size:15px; font-weight:400; color:#999; display:block; margin-top:8px;">Aaj main aapki kya help karoon?</span>
            </div>`;
    }

    function loadChat(id) {
        currentChatId = id;
        renderSidebar();
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = '';
        const currentChat = chats.find(c => c.id === currentChatId);
        
        if(currentChat && currentChat.messages.length > 0) {
            currentChat.messages.forEach(msg => appendStaticMessage(msg.role, msg.content));
        } else {
            chatBox.innerHTML = `<div style="text-align:center; margin-top:80px; color:#ccc; font-size:22px; font-weight:600;">Hello ${userName}! ðŸ‘‹<br><span style="font-size:15px; font-weight:400; color:#999; display:block; margin-top:8px;">Aaj main aapki kya help karoon?</span></div>`;
        }
        closeSidebarMobile();
    }

    function saveData() { localStorage.setItem('utkarsh_chats', JSON.stringify(chats)); }

    function renderSidebar() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        chats.forEach(chat => {
            const div = document.createElement('div');
            div.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
            div.innerText = chat.title;
            div.onclick = () => loadChat(chat.id);
            list.appendChild(div);
        });
    }

    function appendStaticMessage(role, content) {
        const chatBox = document.getElementById('chat-box');
        if(chatBox.innerHTML.includes("Hello " + userName)) chatBox.innerHTML = '';

        let html = '';
        if (role === 'user') {
            html = `<div class="message-row user"><div class="message-content"><div class="bubble">${content}</div></div></div>`;
        } else {
            html = `<div class="message-row ai"><div class="message-content"><div class="avatar ai-avatar"><i class="fa-solid fa-bolt"></i></div><div class="bubble">${marked.parse(content)}</div></div></div>`;
        }
        chatBox.insertAdjacentHTML('beforeend', html);
        MathJax.typesetPromise();
        setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
    }

    function appendTypingMessage(content) {
        return new Promise((resolve) => {
            const chatBox = document.getElementById('chat-box');
            if(chatBox.innerHTML.includes("Hello " + userName)) chatBox.innerHTML = '';
            
            const msgId = 'msg-' + Date.now();
            const html = `<div class="message-row ai"><div class="message-content"><div class="avatar ai-avatar"><i class="fa-solid fa-bolt"></i></div><div class="bubble" id="${msgId}"></div></div></div>`;
            chatBox.insertAdjacentHTML('beforeend', html);
            
            const bubble = document.getElementById(msgId);
            let index = 0;
            const speed = 12; 
            
            let timer = setInterval(() => {
                index += 4; 
                if (index >= content.length) {
                    index = content.length;
                    clearInterval(timer);
                    bubble.innerHTML = marked.parse(content); 
                    MathJax.typesetPromise();
                    resolve();
                } else {
                    bubble.innerHTML = marked.parse(content.substring(0, index)) + '<span class="typing-cursor"></span>';
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            }, speed);
        });
    }

    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const sendBtn = document.getElementById('send-btn');
        const badge = document.getElementById('file-badge');

        const text = inputField.value.trim();
        const file = fileInput.files[0];

        if (!text && !file) return;

        let currentChat = chats.find(c => c.id === currentChatId);

        if (currentChat.messages.filter(m => m.role === 'user').length === 0 && text) {
            currentChat.title = text.substring(0, 25) + (text.length > 25 ? "..." : "");
            renderSidebar(); 
        }

        let displayUserText = text;
        if (file) displayUserText += `<br><span style="color:#666; font-size:12px; display:inline-block; margin-top:5px; background:#e5e5e5; padding:4px 8px; border-radius:10px;"><i class="fa-solid fa-image"></i> ${file.name}</span>`;
        
        appendStaticMessage('user', displayUserText);
        currentChat.messages.push({ role: 'user', content: text }); 
        saveData();

        inputField.value = '';
        inputField.style.height = 'auto';
        fileInput.value = '';
        badge.style.display = 'none';
        sendBtn.disabled = true;

        const formData = new FormData();
        formData.append('prompt', text);
        formData.append('history', JSON.stringify(currentChat.messages));
        formData.append('user_name', userName); 
        if (file) formData.append('file', file);

        try {
            const response = await fetch('/chat', { method: 'POST', body: formData });
            const result = await response.json();

            if (result.error) {
                appendStaticMessage('ai', `âš ï¸ Error: ${result.error}`);
            } else {
                await appendTypingMessage(result.content);
                currentChat.messages.push({ role: 'ai', content: result.content });
                saveData(); 
            }
        } catch (error) {
            appendStaticMessage('ai', 'âš ï¸ Server connection lost.');
        } finally {
            sendBtn.disabled = false;
            setTimeout(() => { document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight; }, 100);
        }
    }
</script>

</body>
</html>